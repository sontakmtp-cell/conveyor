
# Káº¿ hoáº¡ch triá»ƒn khai cho Cursor

## 0) NguyÃªn táº¯c & má»¥c tiÃªu

* **Chá»n há»™p sá»‘ trÆ°á»›c**, Ä‘á»ƒ tá»‘c Ä‘á»™ trá»¥c ra **khÃ´ng lá»›n hÆ¡n nhiá»u** so vá»›i tá»‘c Ä‘á»™ puly yÃªu cáº§u.
* Sau Ä‘Ã³ chá»n **tá»‰ sá»‘ nhÃ´ng \~ 2.0** (Æ°u tiÃªn 1.6â€“2.2) â†’ giáº£m mÃ i mÃ²n.
* Tá»‘i Æ°u theo thá»© tá»±: **sai sá»‘ váº­n tá»‘c** â†’ **tá»•ng sá»‘ rÄƒng nhá»** â†’ **i\_s gáº§n 1.9** â†’ **(tuá»³ chá»n) chi phÃ­**.
* (Náº¿u cÃ³ dá»¯ liá»‡u) **kiá»ƒm tra bá»n xÃ­ch** vá»›i há»‡ sá»‘ an toÃ n.

---

## 1) Viá»‡c cáº§n lÃ m theo commit (atomic)

### 1.1. specs.py â€“ chuáº©n hÃ³a danh sÃ¡ch há»™p sá»‘ & tham sá»‘

**File:** `core/specs.py`
**Tasks**

* Thay `STANDARD_GEARBOX_RATIOS` sang danh sÃ¡ch quÃ©t **giáº£m dáº§n**:

  ```python
  STANDARD_GEARBOX_RATIOS = [100, 80, 60, 50, 40, 30, 25, 20, 15, 12.5, 10, 8, 6, 5]
  ```
* (Tuá»³ chá»n) thÃªm:

  ```python
  CHAIN_SAFETY_FACTOR_DEFAULT = 8.0
  PREFERRED_CHAIN_RATIO = 1.9
  PREFERRED_CHAIN_RANGE = (1.6, 2.2)
  ```

**Acceptance**

* Import Ä‘Æ°á»£c tá»« engine, khÃ´ng gÃ¢y lá»—i.
* Ratios quÃ©t theo thá»© tá»± giáº£m dáº§n.

### 1.2. engine.py â€“ thay tháº¿ logic chá»n truyá»n Ä‘á»™ng

**File:** `core/engine.py`
**Tasks**

* **Thay háº³n** hÃ m `select_transmission(...)` báº±ng phiÃªn báº£n má»›i (Ä‘Ã£ gá»­i á»Ÿ tin trÆ°á»›c).
  Äiá»ƒm chÃ­nh:

  * TÃ­nh $n_{pulley,req}$ tá»« $V$ vÃ  $D$.
  * Lá»c cÃ¡c `ig` cÃ³ $i_{s,tar} = n_{out}/n_{pulley,req}$ náº±m trong $[1.2, 3.0]$, **Æ°u tiÃªn** vÃ¹ng $[1.6, 2.2]$.
  * QuÃ©t `z1` = 17..25, tÃ­nh `z2 = round(z1*i_s_tar)` (giá»›i háº¡n â‰¤120).
  * TÃ­nh váº­n tá»‘c thá»±c táº¿, sai sá»‘ (%).
  * Sáº¯p xáº¿p theo `(error, z1+z2, |i_s-1.9|)`.
  * GÃ¡n xÃ­ch nhá» nháº¥t **Ä‘á»§ bá»n** náº¿u cÃ³ dá»¯ liá»‡u bá»n trong CSV; náº¿u khÃ´ng, váº«n set designation/pitch cÆ¡ báº£n.
* Trong `calculate(...)`: truyá»n `required_power_kw` (náº¿u cÃ³) vÃ o `select_transmission(...)`:

  ```python
  transmission_solution = select_transmission(
      target_velocity=p.V_mps,
      pulley_diameter=result.recommended_pulley_diameters_mm.get('A', 500),
      motor_rpm=p.motor_rpm,
      chain_specs=ACTIVE_CHAIN_SPECS,
      required_power_kw=result.required_power_kw or None
  )
  result.transmission = transmission_solution
  ```

**Acceptance**

* Build/Run khÃ´ng lá»—i.
* In `DEBUG` ngáº¯n gá»n khi tÃ¬m tháº¥y/khÃ´ng tÃ¬m tháº¥y giáº£i phÃ¡p.

### 1.3. models.py â€“ giá»¯ dataclass, Ä‘á»“ng bá»™ trÆ°á»ng

**File:** `core/models.py`
**Tasks**

* **KhÃ´ng** chuyá»ƒn sang Pydantic. Giá»¯ cÃ¡c dataclass nhÆ° hiá»‡n táº¡i.
* Äáº£m báº£o `CalculationResult` cÃ³ `transmission: Optional['TransmissionSolution'] = None` (Ä‘Ã£ cÃ³).
* `TransmissionSolution` giá»¯ cÃ¡c field: `gearbox_ratio`, `drive_sprocket_teeth`, `driven_sprocket_teeth`, `chain_pitch_mm`, `actual_belt_velocity`, `error`, `chain_designation`, `total_transmission_ratio`.

**Acceptance**

* Kiá»ƒu dá»¯ liá»‡u thá»‘ng nháº¥t vá»›i code engine má»›i.
* KhÃ´ng pháº£i sá»­a UI/export vÃ¬ Ä‘á»•i tÃªn trÆ°á»ng.

### 1.4. UI â€“ hiá»ƒn thá»‹ káº¿t quáº£ gá»n, khÃ´ng vá»¡ layout

**Files:**

* `ui/ui_components_3d_enhanced.py` (Output panel)
* `ui/main_window_3d_enhanced.py` (display\_results)

**Tasks**

* ThÃªm group â€œ**Bá»™ truyá»n Ä‘á»™ng**â€ (náº¿u chÆ°a cÃ³):

  * Há»™p sá»‘: `1 : {gearbox_ratio}`
  * NhÃ´ng: `{z1} / {z2}` (â‰ˆ {z2/z1:.2f})
  * Váº­n tá»‘c thá»±c táº¿: `{actual_belt_velocity:.3f} m/s`
  * Sai sá»‘: `{error:.2f}%`
  * XÃ­ch: `{chain_designation} â€” {chain_pitch_mm} mm`
* Náº¿u `result.transmission is None` â†’ hiá»ƒn thá»‹ â€œKhÃ´ng tÃ¬m tháº¥y giáº£i phÃ¡p phÃ¹ há»£pâ€.

**Acceptance**

* Má»Ÿ app â†’ nháº­p bá»™ tham sá»‘ test â†’ tháº¥y khá»‘i â€œBá»™ truyá»n Ä‘á»™ngâ€ hiá»ƒn thá»‹ Ä‘Ãºng.

### 1.5. (Tuá»³ chá»n) reports â€“ thÃªm block â€œBá»™ truyá»n Ä‘á»™ngâ€

**Files:** `reports/exporter_pdf.py`, `reports/exporter_excel.py`
**Tasks**

* ThÃªm báº£ng â€œThÃ´ng sá»‘ bá»™ truyá»n Ä‘á»™ngâ€ vá»›i cÃ¡c trÆ°á»ng y nhÆ° UI.
* Náº¿u `None` â†’ ghi chÃº â€œKhÃ´ng cÃ³â€.

**Acceptance**

* Export PDF/Excel khÃ´ng lá»—i, cÃ³ thÃ´ng tin bá»™ truyá»n Ä‘á»™ng.

---

## 2) Test Plan (quan trá»ng â€“ Ä‘á»ƒ Cursor tá»± cháº¡y)

### 2.1. Unit-like test (script nhá»)

**Táº¡o file** `tests/test_transmission_example.py` (hoáº·c 1 script táº¡m á»Ÿ gá»‘c Ä‘á»ƒ cháº¡y nhanh).
**Arrange**:

* `V = 2.5 m/s`, `D = 630 mm`, `motor_rpm = 1450`.
* Mock `ACTIVE_CHAIN_SPECS` Ä‘á»§ vÃ i máº«u pitch (12.7, 15.875, 19.05â€¦) â€“ náº¿u chÆ°a cÃ³ CSV tÆ°Æ¡ng á»©ng thÃ¬ táº¡o 2â€“3 báº£n ghi dummy (bá» qua bá»n kÃ©o).
  **Act**: gá»i `select_transmission(...)`.
  **Assert (tolerances)**:
* Chá»n há»™p sá»‘ **10** (Æ°u tiÃªn), hoáº·c há»™p sá»‘ khÃ¡c **nhÆ°ng** sao cho $i_s$ náº±m trong \[1.6, 2.2].
* Má»™t nghiá»‡m â€œÄ‘áº¹pâ€: `z1=20, z2=38` (i\_sâ‰ˆ1.90)
* `actual_belt_velocity` trong **Â±2%** so vá»›i 2.5 m/s (tá»©c 2.45â€“2.55 m/s).
* `error < 2%`.

### 2.2. Golden-case (sá»‘ kiá»ƒm)

* $C = 0.63 * 3.1416 â‰ˆ 1.98$ m
* $V_{mpm} = 150$ m/phÃºt
* $n_{pulley,req} â‰ˆ 75.76$ v/phÃºt
* `ig = 10` â†’ $n_{out} = 145$ â†’ $i_{s,tar} â‰ˆ 1.91$.
* Chá»n **(20/38)** â†’ $i_s = 1.90$, $i_{tot} = 19$, $n_{pulley,act} â‰ˆ 76.32$ â†’ $V_{act} â‰ˆ 151.1$ m/phÃºt â†’ $2.518 \, m/s$ â†’ **error â‰ˆ 0.73%** âœ…

### 2.3. Edge cases

* V nhá»/D lá»›n â†’ $n_{pulley,req}$ nhá»: váº«n tÃ¬m Ä‘Æ°á»£c `ig` Ä‘á»ƒ $i_s$ trong \[1.2,3.0].
* KhÃ´ng tÃ¬m Ä‘Æ°á»£c `ig` há»£p lá»‡ â†’ tráº£ `None` (UI/Export pháº£n há»“i tá»­ táº¿).
* CSV thiáº¿u bá»n kÃ©o â†’ váº«n cháº¡y (bá» qua check bá»n).

---

## 3) Chuáº©n Commit / PR checklist

**Commit 1:** `specs: reorder gearbox ratios (desc) + add safety defaults`
**Commit 2:** `engine: replace select_transmission with gearbox-first logic`
**Commit 3:** `ui: show transmission block + graceful no-solution state`
**Commit 4 (opt):** `reports: add transmission section`
**Commit 5:** `tests: add transmission example + edge cases`

**PR description (gá»£i Ã½)**

* Summary: Thay logic chá»n truyá»n Ä‘á»™ng: chá»n há»™p sá»‘ trÆ°á»›c, rá»“i nhÃ´ng \~2.0, giáº£m mÃ i mÃ²n; Æ°u tiÃªn sai sá»‘ nhá».
* Technical notes: cÃ´ng thá»©c tÃ­nh $n_{pulley,req}$, bá»™ tiÃªu chÃ­ sáº¯p xáº¿p (error â†’ z1+z2 â†’ |i\_sâˆ’1.9|), fallback khi thiáº¿u bá»n kÃ©o.
* Risk: thay Ä‘á»•i thuáº­t toÃ¡n â†’ Ä‘Ã£ cÃ³ test vÃ­ dá»¥ 2.5 m/s (sai sá»‘ <1%).
* Screenshots: UI trÆ°á»›c/sau (náº¿u cÃ³).
* Checklist:

  * [ ] Unit script cháº¡y pass
  * [ ] UI hiá»ƒn thá»‹ Ä‘Ãºng
  * [ ] Export khÃ´ng lá»—i
  * [ ] KhÃ´ng phÃ¡ vá»¡ API hiá»‡n cÃ³

---


## 4) Done means done âœ…

* Cháº¡y test vÃ­ dá»¥ cho ra **ig=10** vÃ  **(20/38)** (hoáº·c cáº·p ráº¥t gáº§n 1.9) vá»›i **error < 2%**.
* UI tháº¥y Ä‘á»§ 5 dÃ²ng thÃ´ng tin.
* KhÃ´ng crash dÃ¹ thiáº¿u dá»¯ liá»‡u bá»n kÃ©o.

---

okie, giao â€œCursorâ€ chiáº¿n thÃ´i. cÃ³ gÃ¬ khá»±ngâ€¦ huÃ½t sÃ¡o gá»i mÃ¬nh, mÃ¬nh láº¡i â€œváº·n nhÃ´ngâ€ tiáº¿p! ğŸ› ï¸âœ¨
